package it.unipd.dei.eis.core;

import it.unipd.dei.eis.interfaces.IArticle;
import it.unipd.dei.eis.repository.Article;
import it.unipd.dei.eis.repository.ArticleRepository;
import org.junit.Assert;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.util.ArrayList;
import java.util.Map;

class RankerTest {

    Ranker ranker;
    ArrayList<IArticle> articleArrayList;
    ArticleRepository repository;

    @BeforeEach
    void setUp() {
        IArticle article1 = new Article(
                "01",
                "Trump lawyer said to have been waved off searching office for secret records",
                "On the corner of New York’s Park Avenue and 52nd Street, curious onlookers recently stopped in front of a giant green skull sitting in the bed of a truck parked outside the office of Fidelity Investments, the global financial management company. The “Skull of Satoshi”, named after the pseudonymous bitcoin developer Satoshi Nakamoto, is composed almost entirely of computer circuit boards and fitted with tall smokestacks usually found atop coal power plants. The artifact is a project of artist Benjamin Von Wong and is a reference to the massive amounts of carbon emitted from mining the cryptocurrency bitcoin, an endeavor Fidelity is now pursuing. Bitcoin is chiefly known as a wild investment vehicle that – along with many other cryptocurrencies – can seemingly make or lose fortunes overnight in a market where values go up and down quickly and by large margins. But what worries environmentalists and others is the huge amount of electricity used in generating bitcoin and other such currencies – energy that often traces back to fossil fuels and so has a corresponding impact on the climate crisis. As major financial brands speculate in the cryptocurrency world, environmental campaigners want to make sure they know that they are not just taking a financial gamble; there is also an environmental risk. Some are hoping that they can persuade those institutions to try to lessen the impact of crypto-mining. “It’s a big step for a financial institution like Fidelity to launch their own crypto platform. So now more than ever, we need their help,” said Rolf Skar, campaign director at Greenpeace USA, a non-profit environmental advocacy organization. It is a complex situation. But here is a guide to the key issues. What is bitcoin? Bitcoin is a type of cryptocurrency, a decentralized form of currency that is strictly digital rather than physical – unlike dollars, pounds or euros. It is managed and traded on a public, open ledger known as a “blockchain” that records all bitcoin transactions. Though not commonly done, bitcoin can be used to buy material goods. How does bitcoin cause environmental damage? Because cryptocurrencies such as bitcoin are not centralized, there is no singular authority or body to verify transactions. Instead, participants in the bitcoin network “mine”, or compete to solve cryptographic puzzles to generate more of the currency. Whoever solves the puzzle the fastest gets to verify transactions for the chance to add the newest batch of them to the blockchain. The winner is financially rewarded with new cryptocurrency in this process, referred to as “proof of work” (PoW) – the culprit for greenhouse gas emissions. The PoW consensus algorithm used to verify transactions requires large amounts of electricity which is often produced by burning fossil fuels, emitting carbon dioxide and other greenhouse gases that are heating the planet. A 2022 report, titled Revisiting Bitcoin’s Carbon Footprint, conducted by climate and economics researchers across Europe estimates that “Bitcoin mining may be responsible for 65.4 megatonnes of CO2 per year … which is comparable to country-level emissions in Greece (56.6 megatonnes in 2019).” What do environmental groups want? There is a recent push by some environmentalists to reduce the environmental impact of bitcoin by changing the way it is produced. So groups such as Greenpeace are calling out Fidelity and other financial management and payment process companies that have ventured into bitcoin mining. Hence the recent targeting of Fidelity. Skar said that although Fidelity responded to Greenpeace when the group reached out, the response was lackluster. “[Fidelity] seem not to want to talk about the issue. They declined [our request to speak] so far, but it’s an invitation for them and others to step up and put resources towards solutions to deal with the problem of bitcoin mining globally. We think it can be done,” Skar said. How could ‘changing the code’ mitigate environmental damage? The solution, Greenpeace argues, is simple: change the computer code that produces bitcoin in order to consume less electricity and reduce its carbon footprint. This code is open-source, meaning it is publicly accessible to anyone who wants to see or use it. Rather than a PoW verification process, which requires vast amounts of energy, climate activists are arguing for a less energy-intensive verification process that isn’t reliant on speed, such as “proof of stake” (PoS), used by ethereum – another cryptocurrency. How is this Fidelity’s problem? Since bitcoin is decentralized, it has no owner and no one to hold to account for problems the cryptocurrency creates, like wreaking havoc on the environment. The activists advocating for a code change to bitcoin argue that popular financial services corporations like Fidelity have the clout to incentivize such a change, which would be environmentally transformative. “[Fidelity] doesn’t have a climate commitment like other asset managers. Fidelity is the focus because they have been one of the biggest traditional financial players involved in the bitcoin space and they refuse to acknowledge that they have a responsibility and the ability to help fix the problem that bitcoin mining is having on the climate. So this is actually an invitation for them,” Skar said. He called the code change “a win for bitcoin and for climate and for communities”. But would it succeed? Prominent voices in the bitcoin community and some scholars on the topic don’t buy into this solution. Dr Hanna Halaburda is an associate professor of technology, operations and statistics at NYU’s Stern School of Business. Among the classes she teaches are Blockchain and Cryptocurrencies and Foundations of Fintech. In reference to a hypothetical bitcoin protocol change, Halaburda said: “I don’t think it’s going to work. Everybody recognizes [bitcoin] is environmentally unhealthy, but any big changes to bitcoin protocol have been very unsuccessful because you need to get all the miners to agree on that.” Any miners that don’t agree with the protocol change can simply reject the new code and continue running the original code that relies on the energy-intensive PoW. Would other tactics work? Halaburda said there might be another solution: renewable energy. “A lot of [bitcoin] mining companies have set up their contracts with renewable energy companies. The argument is that having these mining facilities as clients means that when there’s an oversupply of energy, it may actually make it more profitable for the renewable energy plants,” she said. This means that these energy companies can mine bitcoin during periods of excess production and oversupply. So instead of letting energy go to waste, money can be made and the wealth can be shared between the cryptocurrency mining facilities and the renewable energy companies with which they have a contract. Fidelity did not respond to the Guardian’s request for comment.",
                null
        );
        IArticle article2 = new Article(
                "02",
                "US supreme court end-of-term decisions could transform key areas of public life",
                "A sharp rise in bitcoin prices has pushed the cryptocurrency above $30,000 (£24,118) for the first time since 10 June last year, just before the Celsius crypto lending company froze withdrawals in the run-up to its collapse. Even given that recovery, the token is still well below its all-time high of $68,000 in November 2021, and far below where it was before the failure of the Terra stablecoin caused the “crypto winter”. Nevertheless, bitcoin’s recent steady increase in value has sparked discussion of another cryptocurrency boom – and reignited fears of widespread manipulation in the market. The collapse of Silicon Valley Bank last month and the broader contagion it has sparked across financial markets led some cryptocurrency fans to turn to bitcoin, the original and most valuable token in the sector, as a way of protecting against fears that the entire traditional “fiat” economy would crumble. That attitude was typified by the US venture capitalist Balaji Srinivasan, who in March bet $1m that the price of a single bitcoin would top $1m by June this year. His claim was that the US dollar would shortly experience hyperinflation, causing the dollar value of a bitcoin to soar. “This is the moment that the world redenominates on bitcoin as digital gold, returning to a model much like before the 20th century,” he tweeted, explaining the bet. “Everything will happen very fast once people check what I’m saying and see that the Federal Reserve has lied about how much money there is in the banks. All dollar holders get destroyed.” Alex Adelman, the chief executive of the bitcoin rewards app Lolli, said Monday’s rally “did not have a clear catalyst”, but that it was “a bellwether of bitcoin’s newly bullish market conditions and strong investor confidence. Bitcoin’s ongoing strength suggests that bitcoin is emerging from so-called ‘crypto winter’ into a new phase of strength and renewed interest from retail and institutional investors.” But the recovery, after bitcoin prices hovered at $28,000 for almost a month before leaping the final $2,000 in a day, has also led to concern about market manipulation. A 2022 report published by the US National Bureau of Economic Research found that “wash trading”, the practice of selling cryptocurrencies between related parties to influence the reported price, averaged “over 70% of the reported volume” on 29 unregulated exchanges. In June 2022, the US Securities and Exchange Commission (SEC) refused permission to launch a bitcoin-linked exchange traded fund, which would allow investors to buy exposure to the cryptocurrency on the public stock markets, after concluding that it was impossible to prevent fraud and manipulation in the market from affecting the price. As well as wash trading, the SEC said the market could be influenced by individuals with a “dominant position” in bitcoin manipulating its pricing, through fraud and manipulation at trading platforms, and through manipulative activity involving stablecoins “including tether”.",
                null
        );
        IArticle article3 = new Article(
                "03",
                "Theranos founder Elizabeth Holmes expected to begin 11-year sentence",
                "The amount of electricity consumed by the largest cryptocurrency networks has decreased by up to 50% as the “crypto winter” continues to eat at the incomes of “miners” and financial contagion spreads further throughout the sector. The electricity consumption of the bitcoin network has fallen by a third from its high of 11 June, down to an annualised 131 terawatt-hours a year, according to estimates from the crypto analyst Digiconomist. That still equates to the annual consumption of Argentina, with a single conventional bitcoin transaction using the same amount of electricity that a typical US household would use over 50 days. The decrease in electricity used for Ethereum, the “programmable money” that underpins much of the recent explosion in crypto projects, has been sharper still, down from a peak of 94TWh a year to 46TWh a year – the annualised consumption of Qatar. The underlying reason for the fall is the same for both currencies, however. The electricity consumption of a cryptocurrency network comes from “mining”, which involves people using purpose-built computers to generate digital lottery tickets that can reward cryptocurrency payouts. The process underpins the security of the networks, but incentivises the network as a whole to waste extraordinary amounts of energy. As the price of cryptocurrencies has fallen – bitcoin peaked at $69,000 (£56,000) earlier this year, and is now hovering at about $20,000 – the value of the rewards to miners has dropped by the same proportion, leaving those in areas with expensive electricity or using older, inefficient mining “rigs” unable to turn a profit. “This is literally putting them out of business, starting with the ones that operate with suboptimal equipment or under suboptimal circumstances (eg inefficient cooling),” said Alex de Vries, the Dutch economist behind Digiconomist. “For bitcoin mining equipment that’s a big issue, because those machines cannot be repurposed to do something else. When they’re unprofitable they’re useless machines. You can keep them around hoping the price will recover or sell them for scrap.” Ethereum, by contrast, can be mined using a normal computer. But it is most profitable to do so using a very powerful graphics card, which has led to widespread supply shortages of the cards and turned many gamers against the industry. The collapse in mining revenue has led to a flood of graphics cards on the second-hand market, as insolvent miners try to recoup their investments, but De Vries warnsit is a lottery to buy one. “These machines are typically operating 24/7 and the components will get hot doing so. Heat [especially for prolonged periods of time] is known to wear out electronics, reducing longevity and reliability. “Right now it will mainly be older GPUs [graphics processing unit] becoming unprofitable, meaning that it’s not unlikely these devices have been used for mining for a long time.” Thankfully for gamers, the falling demand has also led to large price cuts for new components. Although the fall in bitcoin’s price has stabilised over the past week, the wider cryptocurrency sector continues to stumble as a result of the huge price collapse. The latest jolt was caused by the failure of the ersatz cryptobank Celsius, which announced on 12 June that it was halting withdrawals as it faced a liquidity crisis. The failure of Celsius triggered a domino effect across the wider sector: Three Arrows Capital (3AC), a multibillion-dollar hedge fund, experienced its own liquidity crunch as a result, and multiple companies with substantial outstanding loans to 3AC have now had to take emergency measures in turn. Two other companies that offered bank-like services announced large exposures to 3AC. Last week Finblox said the hedge fund’s actions had an “effect on liquidity”, and heavily restricted user withdrawals, dropping the daily limit from $50,000 to $500 while stopping interest payments on deposits. On Wednesday Voyager, which offers 12% on crypto deposits, revealed it had an outstanding loan of $650m to 3AC, more than four times its available cash. Voyager added that it would consider 3AC in default if the hedge fund did not repay the loan in full by Monday morning. The company has also reportedly frozen user withdrawals. Bancor, a decentralised finance protocol that acts as an exchange, lost out to “the recent insolvency of two large centralised entities”, believed to be Celsius and 3AC, and had to impose withdrawal limits. On Thursday another crypto exchange, CoinFLEX, announced that it was pausing withdrawals because of “extreme market conditions”. Amid the collapses, one large cryptocurrency company has emerged as a would-be saviour of the sector. Alameda Ventures, the investment arm of the crypto entrepreneur Sam Bankman-Fried’s empire, centred on his exchange FTX, has bailed out Voyager and the embattled exchange BlockFi, offering multimillion-dollar loans to both companies. The loans have earned him comparisons to JP Morgan, the US banker who stepped in during a 1907 financial crisis and bought up the stock of troubled companies in an effort to halt the collapse.",
                null
        );

        articleArrayList = new ArrayList<>();
        articleArrayList.add(article1);
        articleArrayList.add(article2);
        articleArrayList.add(article3);

        repository = new ArticleRepository();
    }

    @Test
    void rankTest() {
        ranker = new Ranker(repository);

        Map<String, Integer> wordFrequencyMap = ranker.rank();

        Assert.assertTrue(wordFrequencyMap.size() > 0);
    }
}